# Spinach 配置流程详解

**版本**: v0.1.0  
**更新时间**: 2025年10月22日

---

## 📋 总览

Spinach 配置脚本 (`setup_spinach.ps1` / `setup_spinach.bat`) 自动完成 MATLAB 后端的完整配置。

**运行方式**:
```powershell
# PowerShell
.\environments\spinach\setup_spinach.ps1

# 命令提示符
.\environments\spinach\setup_spinach.bat
```

---

## 🔄 完整配置流程 (6个步骤)

### **Step 1/6: 检查 Spinach 安装**

**目的**: 检测 Spinach 工具箱是否已安装

**检测方法**: 
- 检查 `environments/spinach/kernel/` 目录是否存在
- Kernel 文件夹是 Spinach 的核心组件标志

**如果已安装**:
```
✅ Spinach found
询问: "Reconfigure MATLAB settings? (y/N)"
  - 用户选择 N: 保持现有配置,退出
  - 用户选择 Y: 继续配置 MATLAB 路径
```

**如果未安装**:
```
📥 自动下载流程:
1. 从 config.txt 读取配置:
   - SPINACH_VERSION (默认: 2.9.2)
   - SPINACH_GITHUB_URL (默认: https://github.com/IlyaKuprov/Spinach)

2. 构建下载 URL:
   https://github.com/IlyaKuprov/Spinach/archive/refs/tags/2.9.2.zip

3. 下载到临时目录:
   %TEMP%\Spinach-2.9.2.zip

4. 自动解压:
   %TEMP%\Spinach-2.9.2\Spinach-2.9.2\*

5. 复制到安装目录:
   ZULF_NMR_Suite/environments/spinach/
   
6. 清理临时文件
```

**下载失败时**:
- 显示手动下载指示 (GitHub Releases 链接)
- 询问是否有本地安装
- 提供替代方案 (使用 Python 后端)

---

### **Step 2/6: 检测 MATLAB 安装**

**目的**: 自动查找系统中的 MATLAB 安装

**检测策略** (按顺序):

#### 1️⃣ **检查常见安装路径**
```
C:\Program Files\MATLAB\*
C:\Program Files (x86)\MATLAB\*
D:\MATLAB\*
E:\MATLAB\*
C:\MATLAB\*
```

对每个路径:
- 列出所有子文件夹 (R2023b, R2024a, etc.)
- 检查 `bin\matlab.exe` 是否存在
- 提取版本号 (文件夹名称)

#### 2️⃣ **检查 Windows 注册表**
```
HKLM:\SOFTWARE\MathWorks\MATLAB\*
```

对每个注册表项:
- 读取 `MATLABROOT` 键值
- 验证路径存在且有 `bin\matlab.exe`
- 避免与路径检测重复

#### 3️⃣ **未找到时的处理**

**交互模式** (默认):
```
提供3个选项:
1. 手动输入 MATLAB 路径
   - 验证路径有效性
   - 检查 matlab.exe 存在
   
2. 退出去安装 MATLAB
   - 提示安装 R2021b 或更新版本
   
3. 使用 Python 后端
   - 无需 MATLAB
```

**非交互模式** (`-Interactive $false`):
```
❌ 报错退出
显示错误信息和可选方案
```

**成功时**:
```
✅ Found X MATLAB installation(s)
列出所有检测到的版本:
  [1] R2023b
      C:\Program Files\MATLAB\R2023b
  [2] R2024a
      C:\Program Files\MATLAB\R2024a
```

---

### **Step 3/6: 选择 MATLAB 版本**

**目的**: 确定要使用的 MATLAB 版本

**选择策略**:

#### **情况1: 命令行指定路径**
```powershell
setup_spinach.ps1 -MatlabPath "C:\Program Files\MATLAB\R2023b"
```
- 直接使用指定路径
- 验证路径有效性

#### **情况2: 只有一个安装**
```
✅ Auto-selected: R2023b
```
- 自动选择唯一版本
- 无需用户交互

#### **情况3: 多个安装 (交互模式)**
```
询问用户选择:
Select MATLAB version (1-2): _
```
- 用户输入数字 (1, 2, ...)
- 验证选择有效性

#### **情况4: 多个安装 (非交互模式)**
```
✅ Auto-selected newest: R2024a
```
- 按版本号排序
- 自动选择最新版本

---

### **Step 4/6: 配置 MATLAB 启动脚本**

**目的**: 创建 MATLAB 启动脚本,自动加载 Spinach

**生成的文件**: `matlab_startup.m` (项目根目录)

**脚本内容**:
```matlab
% ZULF-NMR Suite - MATLAB Startup Script
% Auto-generated by Spinach Auto-Setup

% Add Spinach to MATLAB path
spinachPath = 'C:\\Users\\...\\ZULF_NMR_Suite\\environments\\spinach';

if exist(spinachPath, 'dir')
    addpath(genpath(spinachPath));  % 递归添加所有子目录
    fprintf('[OK] Spinach loaded from: %s\n', spinachPath);
else
    warning('Spinach directory not found: %s', spinachPath);
end

% Set default number format
format long  % 显示更多小数位

% Display welcome message
fprintf('\n');
fprintf('====================================\n');
fprintf('  ZULF-NMR Suite v0.1.0\n');
fprintf('  MATLAB Backend Ready\n');
fprintf('====================================\n');
fprintf('\n');
```

**功能**:
- ✅ 自动添加 Spinach 到 MATLAB 路径
- ✅ 设置数值显示格式
- ✅ 显示欢迎信息

**使用方法**:
```matlab
% 在 MATLAB 命令行中:
run('matlab_startup.m')

% 或者在 MATLAB 启动时自动运行:
matlab -r "run('C:\...\matlab_startup.m')"
```

---

### **Step 5/6: 安装 MATLAB Engine for Python**

**目的**: 在 Python 环境中安装 `matlabengine` 包,实现 Python-MATLAB 互操作

**前提条件**:
- Python 环境已配置 (`environments/python/python.exe` 存在)
- 已选择 MATLAB 版本

**安装命令**:
```powershell
python.exe -m pip install matlabengine==25.1.2 --quiet --no-warn-script-location
```

**版本说明**:
- `25.1.2`: 对应 MATLAB R2025a
- 版本需要与 MATLAB 版本匹配 (通常向下兼容)

**成功时**:
```
✅ MATLAB Engine for Python installed successfully
```

**失败时** (非致命错误):
```
⚠️ WARNING: Failed to install MATLAB Engine
   This is optional - you can still use MATLAB via subprocess
```

**为什么可选**:
- 如果 `matlabengine` 安装失败,程序会使用 **subprocess 模式**
- Subprocess 模式: 通过命令行调用 MATLAB,功能完整但稍慢
- Engine 模式: 直接嵌入 MATLAB 引擎,速度更快

**常见失败原因**:
1. MATLAB 版本不匹配
2. 缺少 Visual C++ Build Tools (psutil 依赖)
3. 网络问题 (无法下载 matlabengine)

---

### **Step 6/6: 更新配置文件**

**目的**: 将检测到的 MATLAB 和 Spinach 路径写入 `config.txt`

**更新的配置项**:

#### 1️⃣ **MATLAB_PATH**
```ini
# 如果已存在,更新值:
MATLAB_PATH = C:/Program Files/MATLAB/R2023b

# 如果不存在,添加新行:

# MATLAB Configuration (auto-detected)
MATLAB_PATH = C:/Program Files/MATLAB/R2023b
```

#### 2️⃣ **SPINACH_PATH**
```ini
# 如果已存在,更新值:
SPINACH_PATH = C:/Users/.../ZULF_NMR_Suite/environments/spinach

# 如果不存在,添加新行:
SPINACH_PATH = C:/Users/.../ZULF_NMR_Suite/environments/spinach
```

**路径格式**:
- 使用正斜杠 `/` (跨平台兼容)
- 绝对路径 (完整路径,不用相对路径)

**显示结果**:
```
✅ Configuration updated
  Updated config.txt:
    MATLAB_PATH = C:/Program Files/MATLAB/R2023b
    SPINACH_PATH = C:/Users/.../ZULF_NMR_Suite/environments/spinach
```

---

## 🧪 可选: 测试 MATLAB 连接

**交互模式提示**:
```
Optional: Test MATLAB connection...
Launch MATLAB to verify configuration? (y/N): _
```

**如果用户选择 Y**:

1. **创建测试脚本** (`zulf_matlab_test.m`):
```matlab
try
    % Test Spinach
    if exist('spinach_version', 'file')
        ver = spinach_version();
        fprintf('[OK] Spinach loaded successfully\n');
        fprintf('  Version: %s\n', ver);
    else
        warning('Spinach not loaded correctly');
    end
catch e
    warning('Error testing Spinach: %s', e.message);
end

fprintf('\nPress any key to exit...\n');
pause;
exit;
```

2. **启动 MATLAB**:
```powershell
matlab.exe -r "run('matlab_startup.m'); run('zulf_matlab_test.m')"
```

3. **MATLAB 窗口显示**:
```
[OK] Spinach loaded from: C:\...\environments\spinach
[OK] Spinach loaded successfully
  Version: 2.9.2

Press any key to exit...
```

4. **清理临时文件**

---

## ✅ 完成总结

**显示配置摘要**:
```
============================================================
  Spinach Setup Complete!
============================================================

Configuration summary:
  MATLAB Version: R2023b
  MATLAB Path:    C:\Program Files\MATLAB\R2023b
  Spinach Path:   C:\...\environments\spinach
  Startup Script: matlab_startup.m

Next steps:
  1. Launch the suite:
     start.bat  (or)  start.ps1
  2. Select 'MATLAB' backend in startup dialog
  3. Start your ZULF-NMR simulations!

Press Enter to exit...
```

---

## 🔧 高级用法

### **非交互模式**
```powershell
# 完全自动化,无需用户输入
setup_spinach.ps1 -Interactive $false -MatlabPath "C:\Program Files\MATLAB\R2023b"
```

### **指定 MATLAB 路径**
```powershell
# 跳过自动检测,直接使用指定路径
setup_spinach.ps1 -MatlabPath "D:\MATLAB\R2024a"
```

### **更新 Spinach 版本**
```ini
# 编辑 config.txt:
SPINACH_VERSION = 3.0.0  # 假设新版本发布

# 重新运行脚本:
setup_spinach.ps1
```

---

## 📊 配置流程图

```
[开始]
   |
   v
[Step 1] Spinach 已安装?
   |-- 是 --> 询问是否重新配置?
   |            |-- 否 --> [退出]
   |            |-- 是 --> [跳到 Step 2]
   |
   |-- 否 --> 从 config.txt 读取版本号
              |
              v
           下载 Spinach (GitHub)
              |
              v
           解压并安装
              |
              |-- 失败 --> 显示手动指示
              |              |
              |              v
              |           询问本地路径?
              |              |
              v              v
           [继续]        [用户输入] --> [继续]
              |
              v
[Step 2] 检测 MATLAB 安装
   |
   |-- 检查常见路径
   |-- 检查注册表
   |
   v
   找到 MATLAB?
   |-- 是 --> 列出所有版本
   |            |
   |            v
   |         [Step 3] 选择版本
   |            |
   |            |-- 只有1个 --> 自动选择
   |            |-- 多个 --> 用户选择/自动选最新
   |            |
   |            v
   |         [Step 4] 生成 matlab_startup.m
   |            |
   |            v
   |         [Step 5] 安装 matlabengine
   |            |
   |            |-- 成功 --> ✅
   |            |-- 失败 --> ⚠️ (可选,继续)
   |            |
   |            v
   |         [Step 6] 更新 config.txt
   |            |
   |            v
   |         可选: 测试 MATLAB?
   |            |
   |            v
   |         [完成] 显示总结
   |            |
   |            v
   |         [退出]
   |
   |-- 否 --> 交互模式?
              |-- 是 --> 提供3个选项
              |            1. 手动输入路径 --> [继续到 Step 3]
              |            2. 退出安装 MATLAB --> [退出]
              |            3. 使用 Python 后端 --> [退出]
              |
              |-- 否 --> [报错退出]
```

---

## 🛠️ 故障排除

### **Spinach 下载失败**
- 检查网络连接
- 手动从 GitHub Releases 下载
- 使用官方网站 (需注册)

### **MATLAB 未检测到**
- 检查 MATLAB 是否正确安装
- 手动指定路径: `setup_spinach.ps1 -MatlabPath "..."`
- 检查 `bin\matlab.exe` 是否存在

### **matlabengine 安装失败**
- 非致命错误,程序仍可使用 subprocess 模式
- 安装 Visual C++ Build Tools
- 确保 Python 环境正确配置

### **config.txt 未更新**
- 检查文件权限
- 确保 config.txt 存在于项目根目录

---

## 📖 相关文档

- **Spinach 下载指南**: `docs/setup/SPINACH_DOWNLOAD_GUIDE.md`
- **可选包说明**: `docs/troubleshooting/OPTIONAL_PACKAGES.md`
- **安装故障排除**: `docs/troubleshooting/INSTALLATION_CRASH.md`
- **项目结构**: `docs/PROJECT_STRUCTURE.md`

---

**最后更新**: 2025年10月22日  
**作者**: Xuehan Gao, Ajoy Lab
